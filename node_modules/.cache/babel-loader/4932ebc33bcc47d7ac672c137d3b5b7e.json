{"ast":null,"code":"import _slicedToArray from \"/Users/sergey/code/grow/pres2/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\n\nvar _jsxFileName = \"/Users/sergey/code/grow/pres2/src/diamonds/Diamonds.js\",\n    _s = $RefreshSig$();\n\nimport { WebGLRenderTarget, Object3D } from \"three\";\nimport React, { useRef, useMemo, useLayoutEffect } from \"react\";\nimport { useLoader, useThree, useFrame } from \"@react-three/fiber\";\nimport { GLTFLoader } from \"three/examples/jsm/loaders/GLTFLoader\";\nimport lerp from \"lerp\";\nimport BackfaceMaterial from \"./BackfaceMaterial\";\nimport RefractionMaterial from \"./RefractionMaterial\";\nimport { useBlock } from \"../blocks\";\nimport state from \"../store\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nvar dummy = new Object3D();\nexport default function Diamonds() {\n  _s();\n\n  var _useLoader = useLoader(GLTFLoader, \"/diamond.glb\"),\n      nodes = _useLoader.nodes;\n\n  useLayoutEffect(function () {\n    return nodes.pCone1_lambert1_0.geometry.center();\n  }, []);\n\n  var _useThree = useThree(),\n      size = _useThree.size,\n      gl = _useThree.gl,\n      scene = _useThree.scene,\n      camera = _useThree.camera,\n      clock = _useThree.clock;\n\n  var _useBlock = useBlock(),\n      contentMaxWidth = _useBlock.contentMaxWidth,\n      sectionHeight = _useBlock.sectionHeight,\n      mobile = _useBlock.mobile;\n\n  var model = useRef();\n  var ratio = gl.getPixelRatio();\n\n  var _useMemo = useMemo(function () {\n    var envFbo = new WebGLRenderTarget(size.width * ratio, size.height * ratio);\n    var backfaceFbo = new WebGLRenderTarget(size.width * ratio, size.height * ratio);\n    var backfaceMaterial = new BackfaceMaterial();\n    var refractionMaterial = new RefractionMaterial({\n      envMap: envFbo.texture,\n      backfaceMap: backfaceFbo.texture,\n      resolution: [size.width * ratio, size.height * ratio]\n    });\n    return [envFbo, backfaceFbo, backfaceMaterial, refractionMaterial];\n  }, [size, ratio]),\n      _useMemo2 = _slicedToArray(_useMemo, 4),\n      envFbo = _useMemo2[0],\n      backfaceFbo = _useMemo2[1],\n      backfaceMaterial = _useMemo2[2],\n      refractionMaterial = _useMemo2[3];\n\n  useFrame(function () {\n    state.diamonds.forEach(function (data, i) {\n      var t = clock.getElapsedTime() / 5;\n      var x = data.x,\n          offset = data.offset,\n          scale = data.scale,\n          factor = data.factor;\n      var s = contentMaxWidth / 35 * scale;\n      data.pos.set(mobile ? 0 : x, lerp(data.pos.y, -sectionHeight * offset * factor + state.top.current / state.zoom * factor, 0.1), 0);\n      dummy.position.copy(data.pos);\n      if (i === state.diamonds.length - 1) dummy.rotation.set(0, t, 0);else dummy.rotation.set(t, t, t);\n      dummy.scale.set(s, s, s);\n      dummy.updateMatrix();\n      model.current.setMatrixAt(i, dummy.matrix);\n      model.current.instanceMatrix.needsUpdate = true;\n    });\n    gl.autoClear = false;\n    camera.layers.set(0);\n    gl.setRenderTarget(envFbo);\n    gl.clearColor();\n    gl.render(scene, camera);\n    gl.clearDepth();\n    camera.layers.set(1);\n    model.current.material = backfaceMaterial;\n    gl.setRenderTarget(backfaceFbo);\n    gl.clearDepth();\n    gl.render(scene, camera);\n    camera.layers.set(0);\n    gl.setRenderTarget(null);\n    gl.render(scene, camera);\n    gl.clearDepth();\n    camera.layers.set(1);\n    model.current.material = refractionMaterial;\n    gl.render(scene, camera);\n  }, 1);\n  return /*#__PURE__*/_jsxDEV(\"instancedMesh\", {\n    ref: model,\n    layers: 1,\n    args: [nodes.pCone1_lambert1_0.geometry, null, state.diamonds.length],\n    position: [0, 0, 50]\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 68,\n    columnNumber: 10\n  }, this);\n}\n\n_s(Diamonds, \"BpofAc2ZIVlpoz3Z17ecb/MzEe8=\", false, function () {\n  return [useLoader, useThree, useBlock, useFrame];\n});\n\n_c = Diamonds;\n\nvar _c;\n\n$RefreshReg$(_c, \"Diamonds\");","map":{"version":3,"sources":["/Users/sergey/code/grow/pres2/src/diamonds/Diamonds.js"],"names":["WebGLRenderTarget","Object3D","React","useRef","useMemo","useLayoutEffect","useLoader","useThree","useFrame","GLTFLoader","lerp","BackfaceMaterial","RefractionMaterial","useBlock","state","dummy","Diamonds","nodes","pCone1_lambert1_0","geometry","center","size","gl","scene","camera","clock","contentMaxWidth","sectionHeight","mobile","model","ratio","getPixelRatio","envFbo","width","height","backfaceFbo","backfaceMaterial","refractionMaterial","envMap","texture","backfaceMap","resolution","diamonds","forEach","data","i","t","getElapsedTime","x","offset","scale","factor","s","pos","set","y","top","current","zoom","position","copy","length","rotation","updateMatrix","setMatrixAt","matrix","instanceMatrix","needsUpdate","autoClear","layers","setRenderTarget","clearColor","render","clearDepth","material"],"mappings":";;;;;AAAA,SAASA,iBAAT,EAA4BC,QAA5B,QAA4C,OAA5C;AACA,OAAOC,KAAP,IAAgBC,MAAhB,EAAwBC,OAAxB,EAAiCC,eAAjC,QAAwD,OAAxD;AACA,SAASC,SAAT,EAAoBC,QAApB,EAA8BC,QAA9B,QAA8C,oBAA9C;AACA,SAASC,UAAT,QAA2B,uCAA3B;AACA,OAAOC,IAAP,MAAiB,MAAjB;AACA,OAAOC,gBAAP,MAA6B,oBAA7B;AACA,OAAOC,kBAAP,MAA+B,sBAA/B;AACA,SAASC,QAAT,QAAyB,WAAzB;AACA,OAAOC,KAAP,MAAkB,UAAlB;;AAEA,IAAMC,KAAK,GAAG,IAAId,QAAJ,EAAd;AACA,eAAe,SAASe,QAAT,GAAoB;AAAA;;AACjC,mBAAkBV,SAAS,CAACG,UAAD,EAAa,cAAb,CAA3B;AAAA,MAAQQ,KAAR,cAAQA,KAAR;;AACAZ,EAAAA,eAAe,CAAC;AAAA,WAAMY,KAAK,CAACC,iBAAN,CAAwBC,QAAxB,CAAiCC,MAAjC,EAAN;AAAA,GAAD,EAAkD,EAAlD,CAAf;;AAEA,kBAA2Cb,QAAQ,EAAnD;AAAA,MAAQc,IAAR,aAAQA,IAAR;AAAA,MAAcC,EAAd,aAAcA,EAAd;AAAA,MAAkBC,KAAlB,aAAkBA,KAAlB;AAAA,MAAyBC,MAAzB,aAAyBA,MAAzB;AAAA,MAAiCC,KAAjC,aAAiCA,KAAjC;;AACA,kBAAmDZ,QAAQ,EAA3D;AAAA,MAAQa,eAAR,aAAQA,eAAR;AAAA,MAAyBC,aAAzB,aAAyBA,aAAzB;AAAA,MAAwCC,MAAxC,aAAwCA,MAAxC;;AACA,MAAMC,KAAK,GAAG1B,MAAM,EAApB;AACA,MAAM2B,KAAK,GAAGR,EAAE,CAACS,aAAH,EAAd;;AAEA,iBAAoE3B,OAAO,CAAC,YAAM;AAChF,QAAM4B,MAAM,GAAG,IAAIhC,iBAAJ,CAAsBqB,IAAI,CAACY,KAAL,GAAaH,KAAnC,EAA0CT,IAAI,CAACa,MAAL,GAAcJ,KAAxD,CAAf;AACA,QAAMK,WAAW,GAAG,IAAInC,iBAAJ,CAAsBqB,IAAI,CAACY,KAAL,GAAaH,KAAnC,EAA0CT,IAAI,CAACa,MAAL,GAAcJ,KAAxD,CAApB;AACA,QAAMM,gBAAgB,GAAG,IAAIzB,gBAAJ,EAAzB;AACA,QAAM0B,kBAAkB,GAAG,IAAIzB,kBAAJ,CAAuB;AAChD0B,MAAAA,MAAM,EAAEN,MAAM,CAACO,OADiC;AAEhDC,MAAAA,WAAW,EAAEL,WAAW,CAACI,OAFuB;AAGhDE,MAAAA,UAAU,EAAE,CAACpB,IAAI,CAACY,KAAL,GAAaH,KAAd,EAAqBT,IAAI,CAACa,MAAL,GAAcJ,KAAnC;AAHoC,KAAvB,CAA3B;AAKA,WAAO,CAACE,MAAD,EAASG,WAAT,EAAsBC,gBAAtB,EAAwCC,kBAAxC,CAAP;AACD,GAV0E,EAUxE,CAAChB,IAAD,EAAOS,KAAP,CAVwE,CAA3E;AAAA;AAAA,MAAOE,MAAP;AAAA,MAAeG,WAAf;AAAA,MAA4BC,gBAA5B;AAAA,MAA8CC,kBAA9C;;AAYA7B,EAAAA,QAAQ,CAAC,YAAM;AACbM,IAAAA,KAAK,CAAC4B,QAAN,CAAeC,OAAf,CAAuB,UAACC,IAAD,EAAOC,CAAP,EAAa;AAClC,UAAMC,CAAC,GAAGrB,KAAK,CAACsB,cAAN,KAAyB,CAAnC;AACA,UAAQC,CAAR,GAAqCJ,IAArC,CAAQI,CAAR;AAAA,UAAWC,MAAX,GAAqCL,IAArC,CAAWK,MAAX;AAAA,UAAmBC,KAAnB,GAAqCN,IAArC,CAAmBM,KAAnB;AAAA,UAA0BC,MAA1B,GAAqCP,IAArC,CAA0BO,MAA1B;AACA,UAAMC,CAAC,GAAI1B,eAAe,GAAG,EAAnB,GAAyBwB,KAAnC;AACAN,MAAAA,IAAI,CAACS,GAAL,CAASC,GAAT,CAAa1B,MAAM,GAAG,CAAH,GAAOoB,CAA1B,EAA6BtC,IAAI,CAACkC,IAAI,CAACS,GAAL,CAASE,CAAV,EAAa,CAAC5B,aAAD,GAAiBsB,MAAjB,GAA0BE,MAA1B,GAAoCrC,KAAK,CAAC0C,GAAN,CAAUC,OAAV,GAAoB3C,KAAK,CAAC4C,IAA3B,GAAmCP,MAAnF,EAA2F,GAA3F,CAAjC,EAAkI,CAAlI;AACApC,MAAAA,KAAK,CAAC4C,QAAN,CAAeC,IAAf,CAAoBhB,IAAI,CAACS,GAAzB;AACA,UAAIR,CAAC,KAAK/B,KAAK,CAAC4B,QAAN,CAAemB,MAAf,GAAwB,CAAlC,EAAqC9C,KAAK,CAAC+C,QAAN,CAAeR,GAAf,CAAmB,CAAnB,EAAsBR,CAAtB,EAAyB,CAAzB,EAArC,KACK/B,KAAK,CAAC+C,QAAN,CAAeR,GAAf,CAAmBR,CAAnB,EAAsBA,CAAtB,EAAyBA,CAAzB;AACL/B,MAAAA,KAAK,CAACmC,KAAN,CAAYI,GAAZ,CAAgBF,CAAhB,EAAmBA,CAAnB,EAAsBA,CAAtB;AACArC,MAAAA,KAAK,CAACgD,YAAN;AACAlC,MAAAA,KAAK,CAAC4B,OAAN,CAAcO,WAAd,CAA0BnB,CAA1B,EAA6B9B,KAAK,CAACkD,MAAnC;AACApC,MAAAA,KAAK,CAAC4B,OAAN,CAAcS,cAAd,CAA6BC,WAA7B,GAA2C,IAA3C;AACD,KAZD;AAcA7C,IAAAA,EAAE,CAAC8C,SAAH,GAAe,KAAf;AACA5C,IAAAA,MAAM,CAAC6C,MAAP,CAAcf,GAAd,CAAkB,CAAlB;AACAhC,IAAAA,EAAE,CAACgD,eAAH,CAAmBtC,MAAnB;AACAV,IAAAA,EAAE,CAACiD,UAAH;AACAjD,IAAAA,EAAE,CAACkD,MAAH,CAAUjD,KAAV,EAAiBC,MAAjB;AACAF,IAAAA,EAAE,CAACmD,UAAH;AACAjD,IAAAA,MAAM,CAAC6C,MAAP,CAAcf,GAAd,CAAkB,CAAlB;AACAzB,IAAAA,KAAK,CAAC4B,OAAN,CAAciB,QAAd,GAAyBtC,gBAAzB;AACAd,IAAAA,EAAE,CAACgD,eAAH,CAAmBnC,WAAnB;AACAb,IAAAA,EAAE,CAACmD,UAAH;AACAnD,IAAAA,EAAE,CAACkD,MAAH,CAAUjD,KAAV,EAAiBC,MAAjB;AACAA,IAAAA,MAAM,CAAC6C,MAAP,CAAcf,GAAd,CAAkB,CAAlB;AACAhC,IAAAA,EAAE,CAACgD,eAAH,CAAmB,IAAnB;AACAhD,IAAAA,EAAE,CAACkD,MAAH,CAAUjD,KAAV,EAAiBC,MAAjB;AACAF,IAAAA,EAAE,CAACmD,UAAH;AACAjD,IAAAA,MAAM,CAAC6C,MAAP,CAAcf,GAAd,CAAkB,CAAlB;AACAzB,IAAAA,KAAK,CAAC4B,OAAN,CAAciB,QAAd,GAAyBrC,kBAAzB;AACAf,IAAAA,EAAE,CAACkD,MAAH,CAAUjD,KAAV,EAAiBC,MAAjB;AACD,GAjCO,EAiCL,CAjCK,CAAR;AAmCA,sBAAO;AAAe,IAAA,GAAG,EAAEK,KAApB;AAA2B,IAAA,MAAM,EAAE,CAAnC;AAAsC,IAAA,IAAI,EAAE,CAACZ,KAAK,CAACC,iBAAN,CAAwBC,QAAzB,EAAmC,IAAnC,EAAyCL,KAAK,CAAC4B,QAAN,CAAemB,MAAxD,CAA5C;AAA6G,IAAA,QAAQ,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,EAAP;AAAvH;AAAA;AAAA;AAAA;AAAA,UAAP;AACD;;GAzDuB7C,Q;UACJV,S,EAGyBC,Q,EACQM,Q,EAgBnDL,Q;;;KArBsBQ,Q","sourcesContent":["import { WebGLRenderTarget, Object3D } from \"three\"\nimport React, { useRef, useMemo, useLayoutEffect } from \"react\"\nimport { useLoader, useThree, useFrame } from \"@react-three/fiber\"\nimport { GLTFLoader } from \"three/examples/jsm/loaders/GLTFLoader\"\nimport lerp from \"lerp\"\nimport BackfaceMaterial from \"./BackfaceMaterial\"\nimport RefractionMaterial from \"./RefractionMaterial\"\nimport { useBlock } from \"../blocks\"\nimport state from \"../store\"\n\nconst dummy = new Object3D()\nexport default function Diamonds() {\n  const { nodes } = useLoader(GLTFLoader, \"/diamond.glb\")\n  useLayoutEffect(() => nodes.pCone1_lambert1_0.geometry.center(), [])\n\n  const { size, gl, scene, camera, clock } = useThree()\n  const { contentMaxWidth, sectionHeight, mobile } = useBlock()\n  const model = useRef()\n  const ratio = gl.getPixelRatio()\n\n  const [envFbo, backfaceFbo, backfaceMaterial, refractionMaterial] = useMemo(() => {\n    const envFbo = new WebGLRenderTarget(size.width * ratio, size.height * ratio)\n    const backfaceFbo = new WebGLRenderTarget(size.width * ratio, size.height * ratio)\n    const backfaceMaterial = new BackfaceMaterial()\n    const refractionMaterial = new RefractionMaterial({\n      envMap: envFbo.texture,\n      backfaceMap: backfaceFbo.texture,\n      resolution: [size.width * ratio, size.height * ratio]\n    })\n    return [envFbo, backfaceFbo, backfaceMaterial, refractionMaterial]\n  }, [size, ratio])\n\n  useFrame(() => {\n    state.diamonds.forEach((data, i) => {\n      const t = clock.getElapsedTime() / 5\n      const { x, offset, scale, factor } = data\n      const s = (contentMaxWidth / 35) * scale\n      data.pos.set(mobile ? 0 : x, lerp(data.pos.y, -sectionHeight * offset * factor + (state.top.current / state.zoom) * factor, 0.1), 0)\n      dummy.position.copy(data.pos)\n      if (i === state.diamonds.length - 1) dummy.rotation.set(0, t, 0)\n      else dummy.rotation.set(t, t, t)\n      dummy.scale.set(s, s, s)\n      dummy.updateMatrix()\n      model.current.setMatrixAt(i, dummy.matrix)\n      model.current.instanceMatrix.needsUpdate = true\n    })\n\n    gl.autoClear = false\n    camera.layers.set(0)\n    gl.setRenderTarget(envFbo)\n    gl.clearColor()\n    gl.render(scene, camera)\n    gl.clearDepth()\n    camera.layers.set(1)\n    model.current.material = backfaceMaterial\n    gl.setRenderTarget(backfaceFbo)\n    gl.clearDepth()\n    gl.render(scene, camera)\n    camera.layers.set(0)\n    gl.setRenderTarget(null)\n    gl.render(scene, camera)\n    gl.clearDepth()\n    camera.layers.set(1)\n    model.current.material = refractionMaterial\n    gl.render(scene, camera)\n  }, 1)\n\n  return <instancedMesh ref={model} layers={1} args={[nodes.pCone1_lambert1_0.geometry, null, state.diamonds.length]} position={[0, 0, 50]} />\n}\n"]},"metadata":{},"sourceType":"module"}