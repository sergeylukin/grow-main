{"ast":null,"code":"import _slicedToArray from\"/Users/sergey/code/grow/pres2/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{WebGLRenderTarget,Object3D}from\"three\";import React,{useRef,useMemo,useLayoutEffect}from\"react\";import{useLoader,useThree,useFrame}from\"@react-three/fiber\";import{GLTFLoader}from\"three/examples/jsm/loaders/GLTFLoader\";import lerp from\"lerp\";import BackfaceMaterial from\"./BackfaceMaterial\";import RefractionMaterial from\"./RefractionMaterial\";import{useBlock}from\"../blocks\";import state from\"../store\";import{jsx as _jsx}from\"react/jsx-runtime\";var dummy=new Object3D();export default function Diamonds(){var _useLoader=useLoader(GLTFLoader,\"/diamond.glb\"),nodes=_useLoader.nodes;useLayoutEffect(function(){return nodes.pCone1_lambert1_0.geometry.center();},[]);var _useThree=useThree(),size=_useThree.size,gl=_useThree.gl,scene=_useThree.scene,camera=_useThree.camera,clock=_useThree.clock;var _useBlock=useBlock(),contentMaxWidth=_useBlock.contentMaxWidth,sectionHeight=_useBlock.sectionHeight,mobile=_useBlock.mobile;var model=useRef();var ratio=gl.getPixelRatio();var _useMemo=useMemo(function(){var envFbo=new WebGLRenderTarget(size.width*ratio,size.height*ratio);var backfaceFbo=new WebGLRenderTarget(size.width*ratio,size.height*ratio);var backfaceMaterial=new BackfaceMaterial();var refractionMaterial=new RefractionMaterial({envMap:envFbo.texture,backfaceMap:backfaceFbo.texture,resolution:[size.width*ratio,size.height*ratio]});return[envFbo,backfaceFbo,backfaceMaterial,refractionMaterial];},[size,ratio]),_useMemo2=_slicedToArray(_useMemo,4),envFbo=_useMemo2[0],backfaceFbo=_useMemo2[1],backfaceMaterial=_useMemo2[2],refractionMaterial=_useMemo2[3];useFrame(function(){state.diamonds.forEach(function(data,i){var t=clock.getElapsedTime()/9;var x=data.x,offset=data.offset,scale=data.scale,factor=data.factor;var s=contentMaxWidth/35*scale;data.pos.set(mobile?0:x,lerp(data.pos.y,-sectionHeight*offset*factor+state.top.current/state.zoom*factor,0.1),0);dummy.position.copy(data.pos);if(i===state.diamonds.length-1)dummy.rotation.set(0,t,0);else dummy.rotation.set(t,t,t);dummy.scale.set(s,s,s);dummy.updateMatrix();model.current.setMatrixAt(i,dummy.matrix);model.current.instanceMatrix.needsUpdate=true;});gl.autoClear=false;camera.layers.set(0);gl.setRenderTarget(envFbo);gl.clearColor();gl.render(scene,camera);gl.clearDepth();camera.layers.set(1);model.current.material=backfaceMaterial;gl.setRenderTarget(backfaceFbo);gl.clearDepth();gl.render(scene,camera);camera.layers.set(0);gl.setRenderTarget(null);gl.render(scene,camera);gl.clearDepth();camera.layers.set(1);model.current.material=refractionMaterial;gl.render(scene,camera);},1);return/*#__PURE__*/_jsx(\"instancedMesh\",{ref:model,layers:1,args:[nodes.pCone1_lambert1_0.geometry,null,state.diamonds.length],position:[0,0,50]});}","map":{"version":3,"sources":["/Users/sergey/code/grow/pres2/src/diamonds/Diamonds.js"],"names":["WebGLRenderTarget","Object3D","React","useRef","useMemo","useLayoutEffect","useLoader","useThree","useFrame","GLTFLoader","lerp","BackfaceMaterial","RefractionMaterial","useBlock","state","dummy","Diamonds","nodes","pCone1_lambert1_0","geometry","center","size","gl","scene","camera","clock","contentMaxWidth","sectionHeight","mobile","model","ratio","getPixelRatio","envFbo","width","height","backfaceFbo","backfaceMaterial","refractionMaterial","envMap","texture","backfaceMap","resolution","diamonds","forEach","data","i","t","getElapsedTime","x","offset","scale","factor","s","pos","set","y","top","current","zoom","position","copy","length","rotation","updateMatrix","setMatrixAt","matrix","instanceMatrix","needsUpdate","autoClear","layers","setRenderTarget","clearColor","render","clearDepth","material"],"mappings":"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","sourcesContent":["import { WebGLRenderTarget, Object3D } from \"three\"\nimport React, { useRef, useMemo, useLayoutEffect } from \"react\"\nimport { useLoader, useThree, useFrame } from \"@react-three/fiber\"\nimport { GLTFLoader } from \"three/examples/jsm/loaders/GLTFLoader\"\nimport lerp from \"lerp\"\nimport BackfaceMaterial from \"./BackfaceMaterial\"\nimport RefractionMaterial from \"./RefractionMaterial\"\nimport { useBlock } from \"../blocks\"\nimport state from \"../store\"\n\nconst dummy = new Object3D()\nexport default function Diamonds() {\n  const { nodes } = useLoader(GLTFLoader, \"/diamond.glb\")\n  useLayoutEffect(() => nodes.pCone1_lambert1_0.geometry.center(), [])\n\n  const { size, gl, scene, camera, clock } = useThree()\n  const { contentMaxWidth, sectionHeight, mobile } = useBlock()\n  const model = useRef()\n  const ratio = gl.getPixelRatio()\n\n  const [envFbo, backfaceFbo, backfaceMaterial, refractionMaterial] = useMemo(() => {\n    const envFbo = new WebGLRenderTarget(size.width * ratio, size.height * ratio)\n    const backfaceFbo = new WebGLRenderTarget(size.width * ratio, size.height * ratio)\n    const backfaceMaterial = new BackfaceMaterial()\n    const refractionMaterial = new RefractionMaterial({\n      envMap: envFbo.texture,\n      backfaceMap: backfaceFbo.texture,\n      resolution: [size.width * ratio, size.height * ratio]\n    })\n    return [envFbo, backfaceFbo, backfaceMaterial, refractionMaterial]\n  }, [size, ratio])\n\n  useFrame(() => {\n    state.diamonds.forEach((data, i) => {\n      const t = clock.getElapsedTime() / 9\n      const { x, offset, scale, factor } = data\n      const s = (contentMaxWidth / 35) * scale\n      data.pos.set(mobile ? 0 : x, lerp(data.pos.y, -sectionHeight * offset * factor + (state.top.current / state.zoom) * factor, 0.1), 0)\n      dummy.position.copy(data.pos)\n      if (i === state.diamonds.length - 1) dummy.rotation.set(0, t, 0)\n      else dummy.rotation.set(t, t, t)\n      dummy.scale.set(s, s, s)\n      dummy.updateMatrix()\n      model.current.setMatrixAt(i, dummy.matrix)\n      model.current.instanceMatrix.needsUpdate = true\n    })\n\n    gl.autoClear = false\n    camera.layers.set(0)\n    gl.setRenderTarget(envFbo)\n    gl.clearColor()\n    gl.render(scene, camera)\n    gl.clearDepth()\n    camera.layers.set(1)\n    model.current.material = backfaceMaterial\n    gl.setRenderTarget(backfaceFbo)\n    gl.clearDepth()\n    gl.render(scene, camera)\n    camera.layers.set(0)\n    gl.setRenderTarget(null)\n    gl.render(scene, camera)\n    gl.clearDepth()\n    camera.layers.set(1)\n    model.current.material = refractionMaterial\n    gl.render(scene, camera)\n  }, 1)\n\n  return <instancedMesh ref={model} layers={1} args={[nodes.pCone1_lambert1_0.geometry, null, state.diamonds.length]} position={[0, 0, 50]} />\n}\n"]},"metadata":{},"sourceType":"module"}